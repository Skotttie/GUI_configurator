<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WSA model-viewer</title>
  <link rel="icon" type="image/png" href="data/wsa logo v2.png">
  <link rel="stylesheet" href="teststyle.css">
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
</head>
<body>

<a href="https://www.wsa.com/" target="_blank">
  <img src="data/wsa modelviewer logo.png" alt="Logo" id="logo">
</a>
<img src="data/wsa transparent logo.png" alt="Hintergrund" id="bgImg">

<div id="controls">
  <label>Import File:
    <input type="file" id="fileInput" accept=".glb">
  </label>
  <button id="resetBtn">Reset view ↺</button>
  <button id="selectBtn">Select</button> 
</div>

<div id="sidebarContainer">
  <div id="sidebar">
    <button id="toggleSidebar" type="button" aria-controls="sidebarContent" aria-expanded="false">
      ⯈ Optionen
    </button>
    <div id="sidebarContent">
      <button id="fullscreenBtn">Fullscreen ⛶</button>
      <label class="opt">
        Auto-Rotation 
        <input type="checkbox" id="autoRotateToggle" checked>
      </label>
      <label class="opt">
        Hintergrundfarbe:
        <input type="color" id="bgColorPicker" value="#ffffff">
      </label>
      <button id="resetBgBtn">Standardfarbe</button>
    </div>
  </div>
</div>

<div id="viewerContainer">
  <model-viewer 
    id="viewer" 
    src="data/wsa circle logo.glb"
    alt="3D Modell" 
    camera-controls 
    auto-rotate 
    auto-rotate-delay="1000"
    rotation-per-second="30deg" 
    shadow-intensity="1">
  </model-viewer>
</div>

<div id="infoSlot">
  <h3 id="modelName">No model loaded</h3>
  <p id="modelPrice">Price: -</p>
  <p id="modelDesc">No information available</p>
</div>

<script>
const fileInput = document.getElementById('fileInput');
const viewer = document.querySelector("model-viewer");
const resetBtn = document.getElementById('resetBtn');
const fullscreenBtn = document.getElementById('fullscreenBtn');
const toggleSidebarBtn = document.getElementById('toggleSidebar');
const sidebar = document.getElementById('sidebar');
const autoRotateToggle = document.getElementById("autoRotateToggle");
const bgColorPicker = document.getElementById("bgColorPicker");
const resetBgBtn = document.getElementById("resetBgBtn");

// Startwerte Kamera
let startOrbit, startTarget, startFieldOfView;

// Funktion zum Speichern der Startwerte
function saveStartCameraValues() {
  startOrbit = viewer.cameraOrbit;
  startTarget = viewer.cameraTarget;
  startFieldOfView = viewer.fieldOfView;
  console.log("Startwerte gespeichert:", startOrbit, startTarget, startFieldOfView);
}

// Viewer lädt erstes Standardmodell -> Startwerte sichern
viewer.addEventListener("load", () => {
  saveStartCameraValues();
}, { once: true });

// Infoslot-Datenbank laden
let modelInfos = {};
let modelInfosLoaded = false;

// JSON-Daten laden
fetch('data/modelInfos.json')
  .then(response => response.json())
  .then(data => { 
    modelInfos = data;
    modelInfosLoaded = true;
  })
  .catch(err => console.error("Fehler beim Laden der Datenbank:", err));

fileInput.addEventListener('change', (event) => {
  const file = event.target.files[0];
  if (!file) return;

  const url = URL.createObjectURL(file);
  viewer.src = url;
  viewer.autoRotate = true;

  // Viewer lädt Objekt
  viewer.addEventListener('load', () => {
    URL.revokeObjectURL(url);

    saveStartCameraValues();

    // Infoslot aktualisieren, nur wenn JSON geladen ist
    if(modelInfosLoaded) {
      updateInfoSlot(file.name);
    } else {
      console.log("Warte auf JSON-Daten, Infoslot wird später aktualisiert.");
    }
  }, { once: true });
});


selectBtn.addEventListener('click', () => {
  const file = fileInput.files[0];
  if (!file) {
    alert("Bitte wähle zuerst eine .glb Datei aus!");
    return;
  }

  const reader = new FileReader();
  reader.onload = () => {
    try {
      sessionStorage.setItem("glbDataUrl", reader.result);
      sessionStorage.setItem("glbFileName", file.name);

      // Infoslot aktualisieren, JSON muss geladen sein
      if(modelInfosLoaded) updateInfoSlot(file.name);

      fileInput.value = "";
      window.location.href = "arPlatform.html";
    } catch(e) {
      console.error("Fehler beim Speichern:", e);
      alert("Datei konnte nicht gespeichert werden. Eventuell zu groß.");
    }
  };
  reader.readAsDataURL(file);
});


// Infoslot aktualisieren
function updateInfoSlot(fileName) {
  const info = modelInfos[fileName];
  const modelNameEl = document.getElementById("modelName");
  const modelPriceEl = document.getElementById("modelPrice");
  const modelDescEl = document.getElementById("modelDesc");

  if (info) {
    modelNameEl.textContent = info.name;
    modelPriceEl.textContent = "Price: " + info.price;
    modelDescEl.textContent = "Description: " + info.desc;
  } else {
    modelNameEl.textContent = "unknown model";
    modelPriceEl.textContent = "Price: -";
    modelDescEl.textContent = "Description: no information available.";
  }
}

// Reset Kamera
resetBtn.addEventListener('click', () => {
  if (startOrbit && startTarget && startFieldOfView) {
    viewer.cameraOrbit = startOrbit;
    viewer.cameraTarget = startTarget;
    viewer.fieldOfView = startFieldOfView;
    viewer.jumpCameraToGoal();
  }
});

// Vollbild
fullscreenBtn.addEventListener('click', () => {
  if (!document.fullscreenElement) viewer.requestFullscreen();
  else document.exitFullscreen();
});

// Sidebar toggle
toggleSidebarBtn.addEventListener('click', () => {
  const isOpen = sidebar.classList.toggle('open');
  toggleSidebarBtn.textContent = isOpen ? '⯆ Optionen' : '⯈ Optionen';
  toggleSidebarBtn.setAttribute('aria-expanded', String(isOpen));
});

// Auto-Rotation
autoRotateToggle.addEventListener("change", () => {
  if (autoRotateToggle.checked) viewer.setAttribute("auto-rotate", "");
  else viewer.removeAttribute("auto-rotate");
});

// Hintergrundfarbe
const defaultViewerBg = "#e0e0e0";
bgColorPicker.addEventListener("input", () => { viewer.style.background = bgColorPicker.value; });
resetBgBtn.addEventListener("click", () => {
  viewer.style.background = defaultViewerBg;
  bgColorPicker.value = defaultViewerBg;
});
</script>

</body>
</html>
