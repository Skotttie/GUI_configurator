<!-- ar.html -->
<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MindAR Face: AR</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- MindAR face (CDN; Version wie in den Docs) -->
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-face-aframe.prod.js"></script>

  <style>
    body,html { margin:0; height:100%; }
    a-scene { width:100%; height:100vh; }
    #badge {
      position: fixed; left: 8px; bottom: 8px; z-index:9999;
      background: rgba(0,0,0,0.5); color:#fff; padding:6px 10px; border-radius:6px;
      font-family: system-ui; font-size:13px;
    }
  </style>
</head>
<body>
  <div id="badge">Lade Modell…</div>

  <!-- MindAR A-Frame Szene (Face) -->
  <a-scene mindar-face embedded
           color-space="sRGB"
           renderer="colorManagement: true, physicallyCorrectLights: true"
           vr-mode-ui="enabled: false"
           device-orientation-permission-ui="enabled: false">

    <!-- Kamera (MindAR steuert die Tracking-Kamera) -->
    <a-camera active="false" position="0 0 0"></a-camera>

    <!-- Anchor: anchorIndex sagt wo angeheftet wird -->
<a-entity mindar-face-target="anchorIndex: 4"> <!-- Ohr -->
  <a-entity id="modelEntity"
            scale="0.015 0.015 0.015"
            position="0 -20 0"
            rotation="0 0 0">
  </a-entity>
</a-entity>

<script>
window.addEventListener('DOMContentLoaded', async () => {
  const dataUrl = sessionStorage.getItem('glbDataUrl');
  const fileName = sessionStorage.getItem('glbFileName') || 'Modell';
  const badge = document.getElementById('badge');

  if (!dataUrl) {
    alert('Keine GLB-Datei gefunden! Bitte zuerst upload.html nutzen.');
    badge.textContent = 'Keine Datei gefunden';
    return;
  }

  try {
    const blob = await (await fetch(dataUrl)).blob();
    const objectURL = URL.createObjectURL(blob);
    const modelEl = document.querySelector('#modelEntity');

    // Direkt setzen
    modelEl.setAttribute('gltf-model', objectURL);

    // Optional: Scale/Offset für Nasenspitze
    modelEl.setAttribute('position', '-0.5 0.05 -1');
    modelEl.setAttribute('rotation', '0 270 90');
    modelEl.setAttribute('scale', '0.2 0.2 0.2');
    

    // Feedback
    badge.textContent = `Geladen: ${fileName}`;

    modelEl.addEventListener('model-loaded', () => {
      console.log('Modell geladen und bereit für Face-Tracking:', modelEl.object3D);
    });

  } catch (err) {
    console.error('Fehler beim Laden des Modells in AR:', err);
    badge.textContent = 'Fehler beim Laden des Modells';
  }
});
</script>

</body>
</html>
